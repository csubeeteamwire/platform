---
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

stages:
  - startup
  - ansible-lint
  - Shell check
  - Golint

default:
  tags:
    - desktop
    - linux

variables:
  ANSIBLE_LINT_IMAGE: "cytopia/ansible-lint:6-0.12"
  ANSIBLE_LINT_CMD: "docker run --rm -v $(pwd):/data $ANSIBLE_LINT_IMAGE"

# --- Define changes ---- #

.ansible-changes:
  only:
    changes:
      - ansible/*

# --- Ensure docker image exisits ---- #

Ensure ansible-lint docker image exists:
  stage: startup
  script: docker pull $ANSIBLE_LINT_IMAGE
  extends: .ansible-changes

# --- ANSIBLE LINT TEST ---- #

Single server test:
  stage: ansible-lint
  script: /bin/bash -c "$ANSIBLE_LINT_CMD ansible/site.yml -x 301 --force-color"
  extends: .ansible-changes
  needs: ['Ensure ansible-lint docker image exists']

Cluster server test:
  stage: ansible-lint
  script: /bin/bash -c "$ANSIBLE_LINT_CMD ansible/playbooks/cluster.yml -x 301 --force-color"
  extends: .ansible-changes
  needs: ['Ensure ansible-lint docker image exists']

Procedure test:
  stage: ansible-lint
  script: /bin/bash -c "$ANSIBLE_LINT_CMD ansible/playbooks/procedures/*.yml -x 301 --force-color"
  extends: .ansible-changes
  needs: ['Ensure ansible-lint docker image exists']

Roles dir test:
  stage: ansible-lint
  script: /bin/bash -c "$ANSIBLE_LINT_CMD ansible/playbooks/roles/*.yml -x 301 --force-color"
  extends: .ansible-changes
  needs: ['Ensure ansible-lint docker image exists']

# ---SHELL CHECK TEST ---- #

Packer Build vmware test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./packer/build-vmware.sh

Packer network fix script test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./packer/scripts/fix-network.sh

Packer shrink test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./packer/scripts/shrink-image.sh

Packer offline image test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./prepare-offline-installation.sh

Packer unique test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./packer/scripts/make-unique.sh

Packer guest tools test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./packer/scripts/vm-guest-tools.sh

OCSP wrapper test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./ansible/roles/frontend/files/ocsp.sh

GIT wrapper test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./ansible/roles/management/files/gitwrapper.sh

Backup / Restore test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./ansible/roles/db/files/backup_restore_db.sh

Offline installation test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./packer/scripts/prepare-offline-installation.sh

TWCTL test:
  stage: Shell check
  script:
    - shellcheck --format=tty --color=always ./ansible/roles/management/files/twctl

# --- GO LINT TEST --- #

OcspResonder test:
  stage: Golint
  script:
    - golint ./ansible/roles/go/files/ocspResponder.go

Archiving test:
  stage: Golint
  script:
    - golint ./ansible/roles/go/files/archiving.go
